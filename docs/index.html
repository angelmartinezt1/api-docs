<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implementación del Generador de Documentación</title>
    <!-- Incluir los estilos CSS de tu plantilla original aquí - V1-->
    <link rel="stylesheet" href="style.css">
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-light">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-dark" disabled>
        <!-- Incluir el script del generador -->
    <!-- Highlight.js JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    
    <script src="doc.js?v=3"></script>
    <script src="api-doc-generator.js?v=3"></script>
    <script src="main.js?v=3"></script>
    
    <!-- Script para cargar y generar la documentación -->
    <script>
        // Loading and error management functions
        function showLoading(message = 'Cargando documentación...', submessage = 'Obteniendo especificación de la API') {
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('errorScreen').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'none';
            document.querySelector('.loading-text').textContent = message;
            document.getElementById('loadingSubtext').textContent = submessage;
        }
        
        function showError(message, details = '', isSimple = false) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            
            const errorScreen = document.getElementById('errorScreen');
            const errorContent = document.querySelector('.error-content');
            const errorIcon = document.querySelector('.error-icon');
            const errorTitle = document.querySelector('.error-title');
            const errorMessage = document.getElementById('errorMessage');
            const errorDetails = document.getElementById('errorDetails');
            const retryButton = document.getElementById('retryButton');
            
            if (isSimple) {
                // Add simple classes for minimalist display
                errorScreen.classList.add('simple');
                errorContent.classList.add('simple');
                errorTitle.classList.add('simple');
                errorMessage.classList.add('simple');
                retryButton.classList.add('simple');
                
                // Hide icon and details for simple display
                errorIcon.style.display = 'none';
                errorDetails.style.display = 'none';
                
                // Update content
                errorTitle.textContent = 'Error de JSON';
                errorMessage.textContent = message;
            } else {
                // Remove simple classes for full display
                errorScreen.classList.remove('simple');
                errorContent.classList.remove('simple');
                errorTitle.classList.remove('simple');
                errorMessage.classList.remove('simple');
                retryButton.classList.remove('simple');
                
                // Show icon and details for full display
                errorIcon.style.display = 'block';
                errorDetails.style.display = 'block';
                
                // Update content
                errorTitle.textContent = 'Error al cargar la documentación';
                errorMessage.textContent = message;
                errorDetails.textContent = details;
            }
        }
        
        function showContent() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        }
        
        // Enhanced loadFromJSON with loading states
        async function loadFromJSONWithStates(jsonFile) {
            try {
                showLoading('Cargando documentación...', `Descargando: ${jsonFile}`);
                
                const response = await fetch(jsonFile);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                showLoading('Procesando especificación...', 'Parseando contenido JSON');
                const config = await response.json();
                
                // Store config globally for search functionality
                window.currentConfig = config;
                
                showLoading('Generando documentación...', 'Construyendo interfaz');
                generator.generateFromJSON(config);
                
                // Wait for generation to complete
                setTimeout(() => {
                    showContent();
                    
                    // Reload search endpoints after documentation is generated
                    setTimeout(() => {
                        loadSearchEndpoints();
                    }, 500);
                }, 1000);
                
            } catch (error) {
                console.error('Error loading JSON config:', error);
                
                let errorMessage = 'No se pudo cargar la especificación de la API';
                let errorDetails = '';
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = 'No se pudo conectar con el servidor';
                    errorDetails = `URL: ${jsonFile}\nVerifica que la URL sea correcta y que el servidor esté disponible.`;
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `Error del servidor: ${error.message}`;
                    errorDetails = `URL: ${jsonFile}\nEl archivo no se encontró o no está disponible.`;
                } else if (error instanceof SyntaxError) {
                    // Use simple display for JSON validation errors
                    const simpleMessage = `El archivo no contiene JSON válido\n${error.message}`;
                    showError(simpleMessage, '', true);
                    return; // Exit early to avoid the regular showError call
                } else {
                    errorMessage = 'Error inesperado al cargar la documentación';
                    errorDetails = `${error.name}: ${error.message}`;
                }
                
                showError(errorMessage, errorDetails);
            }
        }
        
        // Cargar la documentación al iniciar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Check for spec parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const specUrl = urlParams.get('spec');
            
            if (specUrl) {
                console.log('Loading spec from URL:', specUrl);
                // Load from external URL with loading states
                loadFromJSONWithStates(specUrl);
            } else {
                // Fallback: Load from local file
                console.log('Loading local api-config.json');
                loadFromJSONWithStates('api-config.json');
            }
            
            // Initialize search modal
            initializeSearchModal();
            
            // Initialize Highlight.js theme switching
            initializeHighlightTheme();
        });
        
        // Function to initialize Highlight.js theme switching
        function initializeHighlightTheme() {
            // Function to update Highlight.js theme
            function updateHighlightTheme() {
                const isDarkMode = document.body.classList.contains('dark-mode');
                const lightTheme = document.getElementById('hljs-light');
                const darkTheme = document.getElementById('hljs-dark');
                
                if (isDarkMode) {
                    lightTheme.disabled = true;
                    darkTheme.disabled = false;
                } else {
                    lightTheme.disabled = false;
                    darkTheme.disabled = true;
                }
            }
            
            // Update theme on page load
            updateHighlightTheme();
            
            // Listen for theme changes (if there's a theme toggle function)
            if (typeof window.toggleTheme === 'function') {
                const originalToggleTheme = window.toggleTheme;
                window.toggleTheme = function() {
                    originalToggleTheme.call(this);
                    setTimeout(updateHighlightTheme, 100);
                };
            }
            
            // Also listen for manual dark mode class changes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        updateHighlightTheme();
                    }
                });
            });
            
            observer.observe(document.body, {
                attributes: true,
                attributeFilter: ['class']
            });
        }
    </script>
</head>
<body>
     <!-- Widget AI Assistant -->
    <div class="ai-assistant-widget">
        <!-- Botón flotante -->
        <button class="ai-assistant-button minimized" id="aiAssistantButton">
            🤖
        </button>

        <!-- Container del chat -->
        <div class="ai-chat-container" id="aiChatContainer">
            <div class="ai-chat-header">
                <div class="ai-chat-title">
                    🤖 Asistente IA - Documentación
                </div>
                <button class="ai-close-button" id="aiCloseButton">✕</button>
            </div>

            <div class="ai-chat-messages" id="aiChatMessages">
                <div class="message bot">
                    <div class="message-bubble">
                        ¡Hola! 👋 Soy tu asistente de IA para la documentación de la API de Gestión de Órdenes. Puedes preguntarme cualquier cosa sobre los endpoints, parámetros, ejemplos de uso y más. ¿En qué puedo ayudarte hoy?
                    </div>
                    <div class="message-time">Ahora</div>
                </div>
            </div>

            <div class="loading-indicator" id="loadingIndicator">
                <span class="loading-dots">Procesando tu pregunta</span>
            </div>

            <div class="ai-chat-input-area">
                <div class="ai-input-container">
                    <textarea 
                        class="ai-input-field" 
                        id="aiInputField" 
                        placeholder="Escribe tu pregunta sobre la API..." 
                        rows="1"
                    ></textarea>
                    <button class="ai-send-button" id="aiSendButton">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Tu estructura HTML original aquí -->
    <div class="header">
        <div class="logo">
            <!-- Logo se generará automáticamente -->
        </div>
        <div class="header-actions">
            <input type="text" class="search-box" placeholder="Buscar endpoints..." id="searchBox">
            <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-modal-overlay" id="searchModalOverlay"></div>
        <div class="search-modal-content">
            <div class="search-modal-header">
                <div class="search-input-container">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="search-modal-input" id="searchModalInput" placeholder="Buscar endpoints...">
                    <kbd class="search-shortcut">ESC</kbd>
                </div>
            </div>
            <div class="search-modal-body">
                <div class="search-results" id="searchResults">
                    <div class="search-empty-state">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <p>Escribe para buscar endpoints</p>
                    </div>
                </div>
            </div>
            <div class="search-modal-footer">
                <div class="search-shortcuts">
                    <kbd>↑</kbd><kbd>↓</kbd> para navegar
                    <kbd>Enter</kbd> para seleccionar
                    <kbd>ESC</kbd> para cerrar
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="30" fill="none" viewBox="0 0 28 26" class="loading-logo-svg">
                    <path fill="#D93A26" d="M18.69 10.828h2.766c.105 0 .175 0 .245.07V24.62c0 .595.56 1.015 1.155.84 1.296-.525 2.976-1.19 4.201-1.75.21-.105.49-.21.49-.63V2.496a.867.867 0 0 0-.875-.875h-2.065c-.385 0-.7.245-.84.595-.84 2.346-2.45 4.096-4.866 4.516-.105 0-.21.035-.35.035-.455.07-.77.42-.77.875v2.275c0 .49.385.876.875.876z"></path>
                    <path fill="#D93A26" d="M22.331.71c-.105-.105-.28-.21-.455-.21H1.608C.978.5.452.955.452 1.55v3.08c0 .736.14 1.086 1.05 1.086H8.26c.175 0 .315.14.315.315v17.013c0 .315.21.56.525.7.595.245 2.66 1.26 3.36 1.645s1.926-.28 1.926-1.26V6.38c-.035-.245 0-.49.245-.595h2.38c4.83-.455 5.321-4.2 5.356-4.62V.99c0-.105 0-.175-.105-.245z"></path>
                </svg>
            </div>
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
            <div class="loading-text">Cargando documentación...</div>
            <div class="loading-subtext" id="loadingSubtext">Obteniendo especificación de la API</div>
        </div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen" style="display: none;">
        <div class="error-content">
            <div class="error-icon">⚠️</div>
            <div class="error-title">Error al cargar la documentación</div>
            <div class="error-message" id="errorMessage">No se pudo cargar la especificación de la API.</div>
            <div class="error-details" id="errorDetails"></div>
            <button class="retry-button" id="retryButton" onclick="location.reload()">
                🔄 Intentar de nuevo
            </button>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="sidebar">
            <!-- Sidebar se generará automáticamente -->
        </div>
        
        <div class="main-content">
            <!-- Contenido principal se generará automáticamente -->
        </div>
    </div>

    <div class="code-sidebar">
        
        <div class="section-urls" style="margin-top: 50px;">
          <div class="response-header">
            <span class="response-text">Servicios web</span>
          </div>
          <div class="response-content">
            <!-- Lista de endpoints -->
        </div>
        <!-- Code sidebar se generará automáticamente -->
    </div>
</div>

</body>
</html>